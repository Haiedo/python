<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng điều khiển - Expense Splitter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-wallet"></i> Expense Splitter
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">
                            <i class="fas fa-home"></i> Trang chủ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/groups">
                            <i class="fas fa-users"></i> Nhóm
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/expenses">
                            <i class="fas fa-receipt"></i> Chi tiêu
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settlements">
                            <i class="fas fa-money-bill-wave"></i> Thanh toán
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> <span id="username-display">Người dùng</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="fas fa-user"></i> Hồ sơ</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Main Content -->
            <div class="col-12">
                <!-- Header -->
                <div class="dashboard-header">
                    <h1>Bảng điều khiển</h1>
                    <p class="text-muted">Tổng quan chi tiêu của bạn</p>
                </div>

                <!-- Stats Cards -->
                <div class="row">
                    <div class="col-md-3 mb-4">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="stat-label">Tổng nhóm</p>
                                        <h3 class="stat-value" id="total-groups">0</h3>
                                    </div>
                                    <i class="fas fa-users fa-3x text-primary opacity-25"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-4">
                        <div class="card stat-card success">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="stat-label">Chi tiêu</p>
                                        <h3 class="stat-value text-success" id="total-expenses">0</h3>
                                    </div>
                                    <i class="fas fa-receipt fa-3x text-success opacity-25"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-4">
                        <div class="card stat-card warning">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="stat-label">Đã chi</p>
                                        <h3 class="stat-value text-warning" id="total-paid">0đ</h3>
                                    </div>
                                    <i class="fas fa-money-bill fa-3x text-warning opacity-25"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-4">
                        <div class="card stat-card danger">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="stat-label">Đang nợ</p>
                                        <h3 class="stat-value text-danger" id="total-owed">0đ</h3>
                                    </div>
                                    <i class="fas fa-exclamation-triangle fa-3x text-danger opacity-25"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Chi tiêu theo danh mục</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Xu hướng chi tiêu</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="trendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Chi tiêu gần đây</h5>
                                <a href="/expenses" class="btn btn-sm btn-outline-primary">Xem tất cả</a>
                            </div>
                            <div class="card-body">
                                <div id="recent-expenses">
                                    <p class="text-center text-muted">Đang tải...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Thanh toán gần đây</h5>
                                <a href="/settlements" class="btn btn-sm btn-outline-primary">Xem tất cả</a>
                            </div>
                            <div class="card-body">
                                <div id="recent-payments">
                                    <p class="text-center text-muted">Đang tải...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script>
        // Check authentication
        checkAuth();

        let categoryChart, trendChart;

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load stats
                const stats = await DashboardAPI.getStats();
                displayStats(stats);

                // Load charts
                const categoryData = await DashboardAPI.getExpensesByCategory();
                displayCategoryChart(categoryData);

                const trendData = await DashboardAPI.getExpenseTrend();
                displayTrendChart(trendData);

                // Load recent activity
                const activity = await DashboardAPI.getRecentActivity();
                displayRecentActivity(activity);

                // Load profile for username
                const profile = await AuthAPI.getProfile();
                document.getElementById('username-display').textContent = profile.user.full_name || profile.user.username;

            } catch (error) {
                showError('Không thể tải dữ liệu: ' + error.message);
            }
        }

        function displayStats(stats) {
            document.getElementById('total-groups').textContent = stats.total_groups || 0;
            document.getElementById('total-expenses').textContent = stats.total_expenses || 0;
            document.getElementById('total-paid').textContent = formatCurrency(stats.total_paid || 0);
            document.getElementById('total-owed').textContent = formatCurrency(stats.total_owed || 0);
        }

        function displayCategoryChart(data) {
            const ctx = document.getElementById('categoryChart');
            if (categoryChart) categoryChart.destroy();

            const categories = data.categories || [];

            if (categories.length === 0) {
                ctx.parentElement.innerHTML = '<p class="text-center text-muted py-5">Chưa có dữ liệu chi tiêu</p>';
                return;
            }

            const labels = categories.map(c => c.category.name);
            const values = categories.map(c => c.total);

            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#2563eb', '#10b981', '#f59e0b', '#ef4444',
                            '#8b5cf6', '#06b6d4', '#6b7280', '#f97316'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed);
                                    return label + ': ' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayTrendChart(data) {
            const ctx = document.getElementById('trendChart');
            if (trendChart) trendChart.destroy();

            const trend = data.trend || [];

            if (trend.length === 0) {
                ctx.parentElement.innerHTML = '<p class="text-center text-muted py-5">Chưa có dữ liệu xu hướng</p>';
                return;
            }

            const labels = trend.map(t => {
                const date = new Date(t.date);
                return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
            });
            const values = trend.map(t => t.total);

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Chi tiêu',
                        data: values,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Chi tiêu: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayRecentActivity(activity) {
            // Recent expenses
            const expensesHtml = activity.recent_expenses.slice(0, 5).map(expense => `
                <div class="expense-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${expense.description}</strong>
                            <br>
                            <small class="text-muted">${formatDate(expense.created_at)}</small>
                        </div>
                        <div class="text-end">
                            <strong class="text-primary">${formatCurrency(expense.amount)}</strong>
                            <br>
                            <span class="badge bg-${expense.status === 'approved' ? 'success' : 'warning'}">
                                ${expense.status === 'approved' ? 'Đã duyệt' : 'Chờ duyệt'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('recent-expenses').innerHTML = expensesHtml || '<p class="text-center text-muted">Chưa có chi tiêu nào</p>';

            // Recent payments
            const paymentsHtml = activity.recent_payments.slice(0, 5).map(payment => `
                <div class="expense-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>Thanh toán #${payment.id}</strong>
                            <br>
                            <small class="text-muted">${formatDate(payment.created_at)}</small>
                        </div>
                        <div class="text-end">
                            <strong class="text-success">${formatCurrency(payment.amount)}</strong>
                            <br>
                            <span class="badge bg-${payment.status === 'completed' ? 'success' : 'warning'}">
                                ${payment.status === 'completed' ? 'Hoàn thành' : 'Chờ xác nhận'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('recent-payments').innerHTML = paymentsHtml || '<p class="text-center text-muted">Chưa có thanh toán nào</p>';
        }

        // Load data on page load
        loadDashboard();
    </script>
</body>
</html>
